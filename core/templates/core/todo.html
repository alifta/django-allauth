{% extends "base.html" %}
{% load widget_tweaks %}
{% load partials %}
{% load static %}

{% block title %}
Todo
{% endblock %}

{% block content %}

<div class="flex flex-col items-center mx-10  md:mx-20">

    <h1 class="prose-2xl mb-4">{{ user.username }}'s To-Do List</h1>

    <form class="mb-4" hx-post="{% url 'core:submit-todo' %}" hx-target="#todo-table-body" hx-swap="beforeend"
        hx-on::after-request="this.reset()">

        <div class="form-control">
            <label>Task Description</label>
            {% render_field form.description class="input input-bordered max-w-xs" %}
        </div>

        <div class="form-control">
            <label>Is Completed?</label>
            {% render_field form.is_completed class="checkbox checkbox-success" %}
        </div>

        <button type="submit" class="btn btn-primary mt-2">Submit</button>
    </form>

    <table class="table table-zebra w-lg">
        <thead>
            <tr>
                <th>Decscription</th>
                <th>Created</th>
                <th>Completed</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="todo-table-body">
            {% for todo in todos %}
            {% partialdef todo-item-partial inline=True %}
            <tr>
                <td>{{ todo.description }}</td>
                <td>{{ todo.created_at }}</td>
                <td>{{ todo.is_completed }}</td>
                <td>
                    {% if not todo.is_completed %}
                    <button class="btn btn-xs btn-success" hx-post="{% url 'core:complete-todo' todo.id %}"
                        hx-target="closest tr" hx-swap="outerHTML">Mark Complete</button>
                    {% endif %}
                    <button class="btn btn-xs btn-error" hx-delete="{% url 'core:delete-todo' todo.id %}"
                        hx-on:delete-todo="this.closest('tr').remove()">Delete</button>
                </td>
            </tr>
            {% endpartialdef %}
            {% endfor %}
        </tbody>
    </table>

    <div class="divider">API-Based Todos</div>

    <div class="alert alert-info mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>This table fetches data from <code>/api/todos</code> using JWT token authentication via HTMX</span>
    </div>

    <div class="card bg-base-200 shadow-xl p-4 mb-4">
        <button class="btn btn-primary btn-sm" hx-get="/api/todos/" hx-target="#api-todos-table" hx-swap="innerHTML">
            Load Todos from API
        </button>
    </div>

    <div id="api-todos-table">
        <div class="text-center text-gray-500 py-8">
            <p>Click "Load Todos from API" to fetch data using JWT authentication</p>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
    // Handle API response and render table
    document.body.addEventListener('htmx:beforeSwap', function(event) {
        if (event.detail.pathInfo.requestPath === '/api/todos/') {
            try {
                const todos = JSON.parse(event.detail.xhr.responseText);

                // Build HTML table from JSON response
                let tableHtml = `
                    <table class="table table-zebra w-lg">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Description</th>
                                <th>Created</th>
                                <th>Completed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (todos.length === 0) {
                    tableHtml += `
                        <tr>
                            <td colspan="5" class="text-center">No todos found</td>
                        </tr>
                    `;
                } else {
                    todos.forEach(todo => {
                        const createdDate = new Date(todo.created_at).toLocaleString();
                        tableHtml += `
                            <tr>
                                <td>${todo.id}</td>
                                <td>${todo.description || 'No description'}</td>
                                <td>${createdDate}</td>
                                <td>
                                    ${todo.is_completed ?
                                        '<span class="badge badge-success">Yes</span>' :
                                        '<span class="badge badge-warning">No</span>'}
                                </td>
                                <td>
                                    ${!todo.is_completed ?
                                        `<button class="btn btn-xs btn-success"
                                            hx-patch="/api/todos/${todo.id}/"
                                            hx-vals='{"is_completed": true}'
                                            hx-trigger="click"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML">
                                            Mark Complete
                                        </button>` : ''}
                                    <button class="btn btn-xs btn-error"
                                        hx-delete="/api/todos/${todo.id}/"
                                        hx-trigger="click"
                                        hx-target="closest tr"
                                        hx-swap="outerHTML swap:1s"
                                        hx-confirm="Are you sure you want to delete this todo?">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }

                tableHtml += `
                        </tbody>
                    </table>
                `;

                event.detail.serverResponse = tableHtml;
            } catch (e) {
                console.error('Error parsing API response:', e);
                event.detail.serverResponse = '<div class="alert alert-error">Failed to load todos from API</div>';
            }
        }
    });

    // Handle successful DELETE responses
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.successful && event.detail.xhr.status === 204) {
            // For DELETE requests that return 204, remove the row
            if (event.detail.pathInfo.requestPath.includes('/api/todos/') &&
                event.detail.verb === 'delete') {
                event.target.closest('tr').remove();
            }
        }
    });

    // Handle PATCH response for marking complete
    document.body.addEventListener('htmx:beforeSwap', function(event) {
        if (event.detail.pathInfo.requestPath.includes('/api/todos/') &&
            event.detail.verb === 'patch') {
            try {
                const todo = JSON.parse(event.detail.xhr.responseText);
                const createdDate = new Date(todo.created_at).toLocaleString();

                const newRow = `
                    <tr>
                        <td>${todo.id}</td>
                        <td>${todo.description || 'No description'}</td>
                        <td>${createdDate}</td>
                        <td>
                            ${todo.is_completed ?
                                '<span class="badge badge-success">Yes</span>' :
                                '<span class="badge badge-warning">No</span>'}
                        </td>
                        <td>
                            <button class="btn btn-xs btn-error"
                                hx-delete="/api/todos/${todo.id}/"
                                hx-trigger="click"
                                hx-target="closest tr"
                                hx-swap="outerHTML swap:1s"
                                hx-confirm="Are you sure?">
                                Delete
                            </button>
                        </td>
                    </tr>
                `;

                event.detail.serverResponse = newRow;
            } catch (e) {
                console.error('Error handling PATCH response:', e);
            }
        }
    });
</script>
{% endblock %}